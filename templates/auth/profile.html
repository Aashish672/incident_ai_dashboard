{% extends "base.html" %}
{% block title %}Profile | Incident AI{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto p-6">
  <h2 class="text-2xl font-bold mb-4 flex items-center gap-2">
    ðŸ‘¤ Profile
    {% if profile and profile.role %}
      <span class="px-2 py-1 rounded text-xs font-semibold
        {% if profile.role == 'admin' %} bg-green-100 text-green-700
        {% else %} bg-gray-100 text-gray-700 {% endif %}">
        {{ profile.role|title }}
      </span>
    {% else %}
      <span class="px-2 py-1 rounded text-xs font-semibold bg-gray-100 text-gray-700">
        Viewer
      </span>
    {% endif %}
  </h2>

  <!-- Stats -->
  <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
    <div class="bg-white p-4 rounded-xl shadow">
      <h4 class="text-sm text-gray-500 mb-1">Your Total Logs</h4>
      <p class="text-3xl font-bold text-blue-600">{{ logs_count }}</p>
    </div>
    <div class="bg-white p-4 rounded-xl shadow">
      <h4 class="text-sm text-gray-500 mb-1">Your Anomalies</h4>
      <p class="text-3xl font-bold text-red-600">{{ anomalies_count }}</p>
    </div>
  </div>

  <div class="bg-white p-6 rounded-xl shadow mb-6">
    <dl class="grid grid-cols-1 sm:grid-cols-2 gap-4">
      <div>
        <dt class="text-sm text-gray-500">Username</dt>
        <dd class="text-lg font-semibold text-gray-800">{{ user.username }}</dd>
      </div>

      <div>
        <dt class="text-sm text-gray-500">Email</dt>
        <dd class="text-lg font-semibold text-gray-800">{{ user.email|default:"â€”" }}</dd>
      </div>

      <div>
        <dt class="text-sm text-gray-500">Last login</dt>
        <dd class="text-lg font-semibold text-gray-800">
          {{ user.last_login|date:"Y-m-d H:i:s" }}
        </dd>
      </div>

      <div>
        <dt class="text-sm text-gray-500">Joined on</dt>
        <dd class="text-lg font-semibold text-gray-800">{{ user.date_joined|date:"Y-m-d H:i:s" }}</dd>
      </div>
    </dl>

    <div class="mt-6 flex gap-3">
      <a href="{% url 'password_change' %}"
         class="inline-block bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
        Change Password
      </a>
      <a href="{% url 'profile_edit' %}"
         class="inline-block bg-gray-800 text-white px-4 py-2 rounded hover:bg-gray-900">
        Edit Profile
      </a>
    </div>
  </div>

  <!-- Recent Logs -->
  <div class="bg-white p-6 rounded-xl shadow mb-8">
    <h3 class="text-lg font-semibold mb-4">ðŸ•’ Recent Logs (last 5)</h3>
    {% if recent_logs %}
      <ul class="space-y-3">
        {% for log in recent_logs %}
          <li class="border rounded p-3 {% if log.is_anomaly %}bg-red-50{% endif %}">
             <div class="flex justify-between items-center">
               <span class="text-xs text-gray-500">{{ log.timestamp|date:"Y-m-d H:i:s" }}</span>
               <span class="text-xs font-semibold text-gray-700">{{ log.level }}</span>
             </div>
             <div class="font-medium">{{ log.message|truncatechars:100 }}</div>
             <div class="text-xs text-gray-500 italic">Source: {{ log.source }}</div>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="text-gray-500">You havenâ€™t uploaded any logs yet.</p>
    {% endif %}
  </div>

  <hr class="my-8 border-gray-300">

  <!-- Admins and their Viewers -->
  <hr class="my-8 border-gray-300">

{% if profile and profile.role == "viewer" %}
  <h2 class="text-2xl font-bold mb-4">Your Assigned Admin</h2>
  <div class="bg-white p-4 rounded-xl shadow">
    {% if admin %}
      <div class="text-gray-800 font-medium">
        ðŸ‘¤ {{ admin.username }}
        <span class="px-2 py-1 rounded bg-green-100 text-green-700 text-xs font-semibold">Admin</span>
      </div>
      <div class="mt-1 text-gray-500 text-sm">
        Email: {{ admin.email|default:"â€”" }}
      </div>
    {% else %}
      <p class="italic text-red-500">No admin assigned.</p>
    {% endif %}
  </div>
{% elif profile and profile.role == "admin" %}
  <h2 class="text-2xl font-bold mb-4">Viewers Assigned to You</h2>
  <div class="bg-white p-4 rounded-xl shadow">
    {% if assigned_viewers %}
      <ul class="space-y-2">
        {% for viewer in assigned_viewers %}
  <li class="flex items-center gap-2">
    ðŸ‘¤ {{ viewer.user.username }}
    <span class="px-2 py-1 rounded bg-gray-100 text-gray-700 text-xs font-semibold">Viewer</span>
    <span class="text-sm text-gray-500"> ({{ viewer.user.email|default:"â€”" }}) </span>
  </li>
{% endfor %}

      </ul>
    {% else %}
      <p class="italic text-gray-500">No viewers are assigned to you.</p>
    {% endif %}
  </div>
{% endif %}

</div>
{% endblock %}
