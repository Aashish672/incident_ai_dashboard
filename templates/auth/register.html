{% extends "base.html" %}
{% block title %}Register | Incident AI{% endblock %}

{% block content %}
<div class="min-h-[calc(100vh-10rem)] flex items-center justify-center px-4">
  <div class="w-full max-w-md bg-white rounded-xl shadow-lg p-8">
    <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">üìù Create an Account</h2>

    <form method="post" class="space-y-4">
      {% csrf_token %}

      <!-- Username -->
      <div>
        <label class="block text-gray-700 font-medium mb-1" for="id_username">Username</label>
        <input type="text" name="username" id="id_username"
               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
               placeholder="Enter username" value="{{ form.username.value|default:'' }}">
        {% if form.username.errors %}
          <p class="text-red-500 text-sm mt-1">{{ form.username.errors.0 }}</p>
        {% endif %}
      </div>

      <!-- Email -->
      <div>
        <label class="block text-gray-700 font-medium mb-1" for="id_email">Email</label>
        <input type="email" name="email" id="id_email"
               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
               placeholder="Enter your email" value="{{ form.email.value|default:'' }}">
        {% if form.email.errors %}
          <p class="text-red-500 text-sm mt-1">{{ form.email.errors.0 }}</p>
        {% endif %}
      </div>

      <!-- Password -->
      <div>
        <label class="block text-gray-700 font-medium mb-1" for="id_password1">Password</label>
        <input type="password" name="password1" id="id_password1"
               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
               placeholder="Enter password">
        {% if form.password1.errors %}
          <p class="text-red-500 text-sm mt-1">{{ form.password1.errors.0 }}</p>
        {% endif %}
      </div>

      <!-- Confirm Password -->
      <div>
        <label class="block text-gray-700 font-medium mb-1" for="id_password2">Confirm Password</label>
        <input type="password" name="password2" id="id_password2"
               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
               placeholder="Re-enter password">
        {% if form.password2.errors %}
          <p class="text-red-500 text-sm mt-1">{{ form.password2.errors.0 }}</p>
        {% endif %}
      </div>

      <!-- Role selection -->
      <div>
        <label class="block text-gray-700 font-medium mb-1" for="id_role">Role</label>
        <select name="role" id="id_role"
                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
          {% for value, label in form.role.field.choices %}
            <option value="{{ value }}" {% if form.role.value == value %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
        {% if form.role.errors %}
          <p class="text-red-500 text-sm mt-1">{{ form.role.errors.0 }}</p>
        {% endif %}
      </div>

      <!-- Admin selection (hidden unless role is 'viewer') -->
      <div id="admin-select-div" {% if form.role.value != "viewer" %}style="display:none"{% endif %}>
        <label class="block text-gray-700 font-medium mb-1" for="id_admin">Assign Admin</label>
        <select name="admin" id="id_admin"
                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
          <option value="">---------</option>
          {% for admin in form.fields.admin.queryset %}
            <option value="{{ admin.pk }}" {% if form.admin.value == admin.pk|stringformat:"s" %}selected{% endif %}>{{ admin.username }}</option>
          {% endfor %}
        </select>
        {% if form.admin.errors %}
          <p class="text-red-500 text-sm mt-1">{{ form.admin.errors.0 }}</p>
        {% endif %}
      </div>

      <!-- Register Button -->
      <button type="submit"
              class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 rounded-lg transition">
        Register
      </button>

      <p class="text-center text-sm text-gray-600 mt-4">
        Already have an account?
        <a href="{% url 'login' %}" class="text-blue-600 hover:underline">Login</a>
      </p>
    </form>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  var roleField = document.getElementById('id_role');
  var adminDiv = document.getElementById('admin-select-div');

  function toggleAdminField() {
    if (roleField.value === 'viewer') {
      adminDiv.style.display = '';
    } else {
      adminDiv.style.display = 'none';
      document.getElementById('id_admin').selectedIndex = 0; // clear selection
    }
  }

  roleField.addEventListener('change', toggleAdminField);
  toggleAdminField(); // Initialize on page load
});
</script>
{% endblock %}
