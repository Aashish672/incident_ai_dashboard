{% extends "base.html" %}

{% block content %}
<style>
  canvas {
    max-width: 100%;
    height: auto;
  }
</style>
<div class="p-6">
  <h2 class="text-3xl font-extrabold text-gray-800 mb-6">üìä Incident Dashboard</h2>

  <!-- Date Filter -->
  <form method="get" class="mb-6 flex flex-wrap gap-4 items-end">
    <div>
      <label class="block text-sm font-medium text-gray-700">Start Date</label>
      <input type="date" name="start" value="{{ start }}" class="border rounded p-2" />
    </div>
    <div>
      <label class="block text-sm font-medium text-gray-700">End Date</label>
      <input type="date" name="end" value="{{ end }}" class="border rounded p-2" />
    </div>
    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
      Filter
    </button>
    <a href="{% url 'log_list' %}" class="px-4 py-2 bg-indigo-600 text-white rounded-lg shadow hover:bg-indigo-700 transition">
                ‚Üê Back to Home
    </a>
    <a href="{% url 'upload_logs' %}" class="px-4 py-2 bg-purple-600 text-white rounded-lg shadow hover:bg-purple-700 transition">
                ‚¨ÜÔ∏è Upload Logs
    </a> 
  </form>

  <!-- Summary Cards -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
    <!-- Total Logs -->
    <a href="{% url 'log_list' %}" class="block bg-white hover:bg-blue-50 transition p-6 rounded-2xl shadow-lg border border-blue-100">
      <div class="flex items-center justify-between mb-2">
        <h3 class="text-lg font-semibold text-blue-700">üóÇÔ∏è Total Logs</h3>
        <span class="text-blue-500 text-sm">View All</span>
      </div>
      <p class="text-4xl font-bold text-blue-800">{{ total_logs }}</p>
    </a>

    <!-- Total Anomalies -->
    <a href="{% url 'log_list' %}?anomaly=true" class="block bg-white hover:bg-red-50 transition p-6 rounded-2xl shadow-lg border border-red-100">
      <div class="flex items-center justify-between mb-2">
        <h3 class="text-lg font-semibold text-red-700">üö® Total Anomalies</h3>
        <span class="text-red-500 text-sm">View</span>
      </div>
      <p class="text-4xl font-bold text-red-600">{{ total_anomalies }}</p>
    </a>

    <!-- Log Levels -->
    <a href="{% url 'log_list' %}" class="block bg-white hover:bg-gray-50 transition p-6 rounded-2xl shadow-lg border border-gray-200 cursor-pointer hover:shadow-xl">
      <h3 class="text-lg font-semibold text-gray-800 mb-2">üìà Levels</h3>
      <ul class="text-sm text-gray-700 space-y-1">
        {% for level, count in level_counts.items %}
          <li class="flex items-center">
          <span class="inline-block w-3 h-3 rounded-full mr-2"
              style="background-color: 
                {% if level == 'CRITICAL' %}#ef4444
                {% elif level == 'ERROR' %}#10b981
                {% elif level == 'WARNING' %}#7c3aed
                {% elif level == 'INFO' %}#3b82f6
                {% elif level == 'DEBUG' %}#f59e0b
                {% else %}gray
                {% endif %};">
        </span>
        <span class="font-semibold">{{ level }}</span>: {{ count }}
      </li>
        {% endfor %}
      </ul>
    </a>
  </div>

  <!-- Charts Container -->
<div class="flex flex-wrap gap-6 mt-8">
  <!-- Trend Line Chart -->
  <div class="flex-1 min-w-[300px] bg-white p-6 rounded-2xl shadow border border-gray-100">
    <div class="flex justify-between items-center mb-3">
      <h3 class="text-lg font-semibold">üìÖ Daily Log Trend</h3>
      <button onclick="downloadChart('trendChart', 'log_trend')" class="text-sm text-blue-600 hover:underline">
        üì• Download PNG
      </button>
    </div>
    <canvas id="trendChart" height="100"></canvas>
  </div>

  <!-- Hourly Anomalies Heatmap -->
  <div class="flex-1 min-w-[300px] bg-white p-6 rounded-2xl shadow border border-gray-100">
    <div class="flex justify-between items-center mb-3">
      <h3 class="text-lg font-semibold">üî• Anomalies by Hour</h3>
      <button onclick="downloadChart('hourChart', 'hourly_anomalies')" class="text-sm text-blue-600 hover:underline">
        üì• Download PNG
      </button>
    </div>
    <canvas id="hourChart" height="100"></canvas>
  </div>

  <!-- Pie Chart for Levels -->
  <div class="flex-1 min-w-[300px] bg-white p-6 rounded-2xl shadow border border-gray-100">
    <div class="flex justify-between items-center mb-3">
      <h3 class="text-lg font-semibold">ü•ß Log Level Distribution</h3>
      <button onclick="downloadChart('levelPieChart', 'log_level_pie')" class="text-sm text-blue-600 hover:underline">
        üì• Download PNG
      </button>
    </div>
    <canvas id="levelPieChart" height="100"></canvas>
  </div>
</div>


<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Charts Config -->
<script>
  // Line Chart ‚Äì Logs over Time
  const trendCtx = document.getElementById('trendChart').getContext('2d');
  new Chart(trendCtx, {
    type: 'line',
    data: {
      labels: {{ date_labels|safe }},
      datasets: [{
        label: 'Logs per Day',
        data: {{ date_data|safe }},
        borderColor: '#3b82f6',
        backgroundColor: 'rgba(59, 130, 246, 0.1)',
        fill: true,
        tension: 0.4,
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: false }
      }
    }
  });

  // Bar Chart ‚Äì Anomalies per Hour
  const hourCtx = document.getElementById('hourChart').getContext('2d');
  new Chart(hourCtx, {
    type: 'bar',
    data: {
      labels: {{ hour_labels|safe }},
      datasets: [{
        label: 'Anomalies',
        data: {{ hour_data|safe }},
        backgroundColor: 'rgba(239, 68, 68, 0.7)',
        borderRadius: 4,
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: false }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            stepSize: 1
          }
        }
      }
    }
  });

  // Pie Chart ‚Äì Level Distribution
  const pieCtx = document.getElementById('levelPieChart').getContext('2d');
  new Chart(pieCtx, {
    type: 'pie',
    data: {
      labels: {{ level_labels|safe }},
      datasets: [{
        data: {{ level_data|safe }},
        backgroundColor: [
          '#ef4444', // ERROR - Red
          '#f59e0b', // WARNING - Orange
          '#10b981', // INFO - Green
          '#6366f1', // DEBUG - Indigo
          '#8b5cf6', // CRITICAL - Violet
        ],
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          position: 'bottom'
        }
      }
    }
  });

  // Export chart function
  function downloadChart(canvasId, filename) {
    const canvas = document.getElementById(canvasId);
    const a = document.createElement('a');
    a.download = filename + '.png';
    a.href = canvas.toDataURL('image/png');
    a.click();
  }
</script>
<!-- Real-time Logs Section -->
<div id="realtime-logs" class="space-y-2">
  <h3 class="text-lg font-semibold">ü•ß Real-time Logs</h3>
  {% for log in recent_logs %}
    <div class="p-4 bg-white rounded shadow">
      <div class="text-sm text-gray-500">{{ log.timestamp }}</div>
      <div class="font-semibold text-blue-700">{{ log.level }}</div>
      <div>{{ log.message }}</div>
      <div class="text-sm text-gray-500 italic">{{ log.source }}</div>
    </div>
  {% endfor %}
</div>


<script>
  const protocol = window.location.protocol === "https:" ? "wss://" : "ws://";
  const socket = new WebSocket("ws://" + window.location.hostname + ":8000/ws/logs/");

  socket.onmessage = function(e) {
    const data = JSON.parse(e.data);
    toast.success(data.message);
    const container = document.getElementById("realtime-logs");

    const logCard = `
      <div class="border p-2 mb-2 rounded bg-red-100 shadow">
          <strong>${data.level}</strong> ‚Äî ${data.message} <br>
          <small>${data.timestamp}</small>
      </div>
    `;
    container.innerHTML = logCard + container.innerHTML; // append to top
  };
</script>

{% endblock %}
