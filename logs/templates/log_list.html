{% extends "base.html" %}
{% block title %}Logs | Incident AI{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto py-8 px-4">
  <h2 class="text-3xl font-extrabold text-gray-800 mb-6">üìä Log Entries</h2>

  <!-- Filter Form -->
  <form method="get" class="grid grid-cols-1 md:grid-cols-6 gap-4 mb-6 bg-white p-4 rounded-lg shadow">
    <select name="level" class="p-2 border border-gray-300 rounded-lg">
      <option value="">All Levels</option>
      <option value="INFO" {% if level == 'INFO' %}selected{% endif %}>INFO</option>
      <option value="WARNING" {% if level == 'WARNING' %}selected{% endif %}>WARNING</option>
      <option value="ERROR" {% if level == 'ERROR' %}selected{% endif %}>ERROR</option>
      <option value="CRITICAL" {% if level == 'CRITICAL' %}selected{% endif %}>CRITICAL</option>
      <option value="DEBUG" {% if level == 'DEBUG' %}selected{% endif %}>DEBUG</option>
    </select>

    <label class="flex items-center space-x-2">
      <input type="checkbox" name="anomaly" value="true" class="form-checkbox text-red-500"
             {% if show_anomalies %}checked{% endif %}>
      <span class="text-gray-700">Anomalies Only</span>
    </label>

    <input type="date" name="start" value="{{ start }}" class="p-2 border border-gray-300 rounded-lg" />
    <input type="date" name="end" value="{{ end }}" class="p-2 border border-gray-300 rounded-lg" />

    <input type="text" name="search" value="{{ search_query }}"
           placeholder="Search message or source"
           class="p-2 border border-gray-300 rounded-lg col-span-1 md:col-span-2" />

    <button type="submit"
            class="p-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition duration-200">
      Apply Filters
    </button>
  </form>

  <!-- Buttons -->
  <div class="flex flex-col sm:flex-row sm:space-x-4 space-y-4 sm:space-y-0 mb-6">
    <form method="get" action="{% url 'logs:export_logs_csv' %}">
      <input type="hidden" name="level" value="{{ request.GET.level }}">
      <input type="hidden" name="anomaly" value="{{ request.GET.anomaly }}">
      <input type="hidden" name="start" value="{{ request.GET.start }}">
      <input type="hidden" name="end" value="{{ request.GET.end }}">
      <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">
        Export Filtered Logs as CSV
      </button>
    </form>

    <a href="{% url 'logs:dashboard' %}" class="px-4 py-2 bg-indigo-600 text-white rounded-lg shadow hover:bg-indigo-700 transition">
      ‚Üê Go to Dashboard
    </a>

    <a href="{% url 'logs:upload_logs' %}" class="px-4 py-2 bg-purple-600 text-white rounded-lg shadow hover:bg-purple-700 transition">
      ‚¨ÜÔ∏è Upload Logs
    </a>
  </div>

  <hr class="my-6">

  <div id="log-list-container">
    {% include "_log_list_partial.html" %}
  </div>
</div>

<script>
  function fetchLogs(url) {
    fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
      .then(response => response.text())
      .then(data => {
        document.getElementById('log-list-container').innerHTML = data;
      });
  }

  // Handle pagination clicks dynamically
  document.addEventListener('click', function(e) {
    if (e.target.closest('#log-list-container a')) {
      e.preventDefault();
      fetchLogs(e.target.closest('#log-list-container a').href);
    }
  });

  // Live search (debounced)
  let searchInput = document.querySelector('input[name="search"]');
  let debounceTimeout;
  if (searchInput) {
    searchInput.addEventListener('input', function() {
      clearTimeout(debounceTimeout);
      debounceTimeout = setTimeout(() => {
        let form = searchInput.closest('form');
        fetchLogs(form.action + '?' + new URLSearchParams(new FormData(form)));
      }, 500);
    });
  }
</script>
{% endblock %}
